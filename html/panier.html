<!doctype html>
<html lang="fr">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--Fontawesome-->
    <script src="https://kit.fontawesome.com/1810ba3e26.js" crossorigin="anonymous"></script>
    <!--Css-->
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel=stylesheet href="../public/css/style.css">
    <title>Orinoco Peluches panier</title>
  </head>
  <body id="body">
    <main class="contenu-page">
      <header>
        <nav class="navbar navbar-light bg-light">
            <div class="container-fluid">
              <a class="navbar-brand" href="../index.html"> <img class="logosize" src="../images/logoorinoco.png" alt="logo-orinoco"/> </a>
              <form class="d-flex">
                <a href="../index.html" class="btn btn-outline-danger"><i class="panier">Accueil</i></a>
              </form>
            </div>
          </nav>
      </header>
      <section>
        <h2 class="col-5 titre-panier">Finalisez votre commande <span class="enseigne">Orinoco</span></h2>
        <div class="conteneur-principal">
            <article id="container" class="container-card col-5 partie-panier">
            </article>
            <article class="partie-forms col-5">
            <form class="row g-3">
                <div class="col-md-4">
                  <label for="validationNom" class="form-label">Nom</label>
                  <input type="text" class="form-control" id="validationNom" value="" placeholder="Durant" required>
                </div>
                <div class="col-md-4">
                  <label for="validationPrenom" class="form-label">Prénom</label>
                  <input type="text" class="form-control" id="validationPrenom" placeholder="Dominique" required>
                </div>
                <div class="col-md-4">
                  <label for="validationEmail" class="form-label">Email</label>
                  <div class="input-group">
                    <input type="email" class="form-control" id="validationEmail"  placeholder="@" required>
                  </div>
                </div>
                <div class="col-md-6">
                  <label for="validationAdresse" class="form-label">Adresse</label>
                  <input type="text" class="form-control" id="validationAdresse" placeholder="Entrez votre adresse" required>
                </div>
                <div class="col-md-3">
                  <label for="validationCodePostal" class="form-label">Code Postal</label>
                  <input type="text" class="form-control" id="validationCodePostal" placeholder="CP" required>
                </div>
                <div class="col-md-3">
                  <label for="validationPays" class="form-label">Pays</label>
                  <input type="text" class="form-control" id="validationPays" required>
                </div>
                <div class="col-12">
                  <button id="validerAchat" class="btn btn-primary" type="submit">Acheter</button>
                </div>
              </form>
            </article>
        </div>
      </section>
      <footer> 
      </footer>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
      <script>
          //Recuperation des données du local storage.
          var panierPeluches = JSON.parse(localStorage.getItem("panier")) || [];
          console.log(panierPeluches);

          //creation du contenu de l'affichage du panier.
          let articles = document.getElementById("container");
          let titreEtatPanier = document.createElement("h3");
          titreEtatPanier.classList.add("titre-partie-panier");
          console.log(titreEtatPanier);
          console.log(panierPeluches.length);
          let boutonValider = document.getElementById("validerAchat");
          
          function etatPanier (){
            let etat;
            if(panierPeluches.length >= 1){
                  console.log(panierPeluches.length);
                  etat = titreEtatPanier.textContent="Résumé du panier";
            }else{
                  
              etat = titreEtatPanier.textContent= "Votre panier est vide";

                }
          }

          articles.appendChild(titreEtatPanier);
          let ol = document.createElement("ol");
          
          ol.classList.add("list-group", "list-group-numbered", "ol-contenant");

          //fonction afficher panier
          function afficherPanier (){
            // nettoyage du panier 
            ol.innerHTML="";
            //creation du panier
            panierPeluches.map((article, i) => {
              let lignePanier = document.createElement("li");
              lignePanier.innerHTML= article.name;
              let spanPrix = document.createElement("span");
              spanPrix.innerText= "Prix: " + article.price / 100 +"€";
              lignePanier.classList.add("list-group-item", "justify-content-between", "ligne-panier");
              let enlever = document.createElement("button");
              enlever.classList.add("btn-danger", "retirer");
              enlever.onclick =  function (event){
                panierPeluches.splice(i, 1);
                localStorage.setItem("panier", JSON.stringify(panierPeluches));
                etatPanier();
                afficherPanier ();
              }
              console.log(lignePanier);
              enlever.innerText= "Retirer";
              articles.appendChild(ol);
              ol.appendChild(lignePanier);
              lignePanier.appendChild(spanPrix);
              lignePanier.appendChild(enlever);
              console.log(panierPeluches);
            });
          }
              //test creation de fonction vers la page de remerciement
              function lien (){
              let lienValider = document.createElement("a");
              lienValider.setAttribute("href", "html/valider.html");
              boutonValider.appendChild(lienValider);
              } 

              boutonValider.addEventListener('click', function (event){
                event.preventDefault();
                //recupération des valeurs du formulaire
                let contact ={
                  firstName:document.getElementById("validationNom").value,
                  lastName: document.getElementById("validationPrenom").value,
                  address: document.getElementById("validationAdresse").value,
                  city: document.getElementById("validationCodePostal").value,
                  email: document.getElementById("validationEmail").value
              }
            

                let tableauProduit = JSON.parse(localStorage.getItem("panier")) ||  [];
                var products = JSON.stringify(tableauProduit.map(function(produit) {
                  return produit._id;
                  }));

                console.log(JSON.stringify({contact,products}));
                fetch("http://localhost:3000/api/teddies/order",{
                      method: "POST",
                      headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                      },
                        body: JSON.stringify({contact,products})
                        
                    });


              console.log(tableauProduit);
              })
            afficherPanier ();
            etatPanier();
            lien();

            
      </script>
      </main>
      </body>
      </html>
